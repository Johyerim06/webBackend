import express from 'express';
import morgan from 'morgan';
import cookieParser from 'cookie-parser';
import cors from 'cors';
import { auth } from './middleware/auth.js';
import { authRouter } from './routes/auth.routes.js';
import { clubRouter } from './routes/club.routes.js';
import { eventRouter } from './routes/event.routes.js';
import { availabilityRouter } from './routes/availability.routes.js';
import { voteRouter } from './routes/vote.routes.js';
import { todoRouter } from './routes/todo.routes.js';
import { scheduleRouter } from './routes/schedule.routes.js';
import { personalEventRouter } from './routes/personalEvent.routes.js';
import { meetingRouter } from './routes/meeting.routes.js';

const app = express();

// API ?„ìš© ë¯¸ë“¤?¨ì–´ ?¤ì •
app.use(morgan('dev'));
app.use(cors({
  origin: 'http://localhost:3000',
  credentials: true
}));
app.use(express.json()); // JSON ?Œì‹±
app.use(express.urlencoded({ extended: true })); // form-urlencoded ?Œì‹±
app.use(cookieParser());
app.use(auth);

// API ?¼ìš°???¤ì • (ëª¨ë“  ?¼ìš°?¸ì— /api ?‘ë‘??ì¶”ê?)
app.use('/api/auth', authRouter);
app.use('/api/clubs', clubRouter);
app.use('/api/events', eventRouter);
app.use('/api/availability', availabilityRouter);
app.use('/api/votes', voteRouter);
app.use('/api/todos', todoRouter);
app.use('/api/schedules', scheduleRouter);
app.use('/api/personal-events', personalEventRouter);

// API ?œë²„ ?íƒœ ?•ì¸ ?”ë“œ?¬ì¸??app.get('/api/health', (req, res) => {
  res.json({ 
    status: 'OK', 
    message: 'API Server is running',
    timestamp: new Date().toISOString()
  });
});

// ë£¨íŠ¸ ê²½ë¡œ??API ?œë²„ ?•ë³´ ë°˜í™˜
app.get('/', (req, res) => {
  res.json({ 
    message: 'Club Scheduler API Server',
    version: '1.0.0',
    endpoints: {
      auth: '/api/auth',
      clubs: '/api/clubs',
      events: '/api/events',
      availability: '/api/availability',
      votes: '/api/votes',
      todos: '/api/todos',
      schedules: '/api/schedules'
    }
  });
});

// 404 ?ëŸ¬ ì²˜ë¦¬
app.use('*', (req, res) => {
  res.status(404).json({ error: 'API endpoint not found' });
});

// ?„ì—­ ?ëŸ¬ ì²˜ë¦¬
app.use((err, req, res, next) => {
  console.error('[ERROR] Unhandled error:', err);
  res.status(500).json({ 
    error: process.env.NODE_ENV === 'production' 
      ? 'Internal server error' 
      : err.message 
  });
});

export default app;

